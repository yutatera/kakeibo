<!doctype html>
<html>

<head>
  <meta charset="UTF-8">
  <title>家計簿</title>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
  <style type="text/css">
    .sidebar {
      top:70px;
      position: -webkit-sticky;
      position: sticky;
    }
    body { padding-top: 70px; }
  </style>
</head>
  
<body>
  <!--ナビゲーションウィンドウ-->
  <nav class="navbar navbar-expand navbar-dark bg-dark fixed-top">
    <div class="navbar-brand">家計簿</div>
    <div class="navbar-nav">
      <a class="nav-item nav-link" href="/">推移</a>
      <a class="nav-item nav-link active" href="/future">予測</a>
      <a class="nav-item nav-link" href="/month">月毎・年毎</a>
    </div>
  </nav>
  <div class="container-fluid">
  <div class="row">
    <!--サイドバー-->
    <nav class="col-2 bg-light sidebar">
    <ul class="nav flex-column"></ul>
    </nav>

    <!--メイン-->
    <main role="main" class="col-md-7">
    <h1>予測</h1>
    <canvas id="future" height="50%" width="100%"></canvas>
    <div id="tbl"></div>
    </main>
  </div>
  </div>
  <script>


    var colors = [
        'rgb(  0,   0, 255)',
        'rgb(  0, 203, 255)',
        'rgb(255, 255,   0)',
        'rgb(216, 255, 204)',
        'rgb(  0, 255,   0)',
        'rgb(  0, 101,   0)',
        'rgb(255, 63,    0)',
        'rgb( 203,  0, 203)',
        'rgb(  0,   0,  50)'
    ]

    var trans = function(color, opacity) {
        var alpha = opacity === undefined ? 0.5 : 1 - opacity;
        return Color(color).alpha(alpha).rgbString();
    }

    function areaConfig(x, y){
    var data = {
        labels: x,
        datasets: []
    }
    for (i = 0; i< y.length; i++){
        var fill = true
        if(i > 0){
        fill = "-1"
        }
        val = Object.values(y[i])[0]
        val = val.slice(Math.max(val.length - x.length, 0) , val.length)
        data.datasets[i] = {
        backgroundColor: trans(colors[i % colors.length]),
        borderColor: colors[i % colors.length],
        data: val,
        label: Object.keys(y[i])[0],
        fill : fill
        }
    }
    var options = {
        elements: {
        line: {
            tension: 0.1
        }
        },
        scales: {
        yAxes: [{
            stacked: true,
            ticks: {
            beginAtZero: false
            }
        }]
        },
        legend: {
        display: true,
        }
    }
    var ret = {
        type: 'line',
        data: data,
        options: options
    }
    return ret
    }
    fetch('/get_dataFuture').then(function(response) {
      return response.json();
    }).then(function(dataFuture) {
        chart = new Chart('future', areaConfig(dataFuture["x"], dataFuture["y"]["予測"]))
        var txt = '<table class="table table-striped table-sm table-hover">'
        item = "予測"
        txt += '<thead><tr align="right">'
        txt += '<th>月</th>'
        for (var i = 0; i < dataFuture["y"][item].length; i++){
        txt += '<th>'+ Object.keys(dataFuture["y"][item][i])[0] + '</th>'
        }            
        txt += '</tr></thead>'
        txt += '<tbody>'
        for (var r = 0; r < dataFuture["x"].length; r++) {
        txt += '<tr align="right">'
        txt += '<td>' + dataFuture["x"][r] + '</td>'
        for (var c = 0; c < dataFuture["y"][item].length; c++){
            x = Object.values(dataFuture["y"][item][c])[0][r]
            txt += '<td>' +  String(x).replace( /(\d)(?=(\d\d\d)+(?!\d))/g, '$1,') + '</td>'
        };
        txt += '</tr>'
        }
        txt += '</tbody>'
        txt += '</table>'
        $('#tbl').append(txt)
    })
  </script>
</body>
</html>
