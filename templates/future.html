<!doctype html>
<html>

<head>
  <meta charset="UTF-8">
  <title>家計簿</title>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
  <style type="text/css">
    .sidebar {
      top:70px;
      position: -webkit-sticky;
      position: sticky;
    }
    body { padding-top: 70px; }
  </style>
</head>
  
<body>
  <!--ナビゲーションウィンドウ-->
  <nav class="navbar navbar-expand navbar-dark bg-dark fixed-top">
    <div class="navbar-brand">家計簿</div>
    <div class="navbar-nav">
      <a class="nav-item nav-link" href="index">推移</a>
      <a class="nav-item nav-link active" href="future">予測</a>
      <a class="nav-item nav-link" href="month">月毎・年毎</a>
    </div>
  </nav>
  <div class="container-fluid">
  <div class="row">
    <!--サイドバー-->
    <nav class="col-2 bg-light sidebar">
    <ul class="nav flex-column"></ul>
    </nav>

    <!--メイン-->
    <main role="main" class="col-md-7">
    <h1>予測</h1>
    <canvas id="future" height="50%" width="100%"></canvas>
    <div id="tbl"></div>
    </main>
  </div>
  </div>
  <script>
    url = location.href
    var colors = [
        'rgb(  0,   0, 255)',
        'rgb(  0, 203, 255)',
        'rgb(255, 255,   0)',
        'rgb(216, 255, 204)',
        'rgb(  0, 255,   0)',
        'rgb(  0, 101,   0)',
        'rgb(255, 63,    0)',
        'rgb( 203,  0, 203)',
        'rgb(  0,   0,  50)'
    ]

    var trans = function(color, opacity) {
        var alpha = opacity === undefined ? 0.5 : 1 - opacity;
        return Color(color).alpha(alpha).rgbString();
    }

    function areaConfig(x, y){
    var data = {
        labels: x,
        datasets: []
    }
    for (i = 0; i< y.length; i++){
        var fill = true
        if(i > 0){
        fill = "-1"
        }
        val = Object.values(y[i])[0]
        val = val.slice(Math.max(val.length - x.length, 0) , val.length)
        data.datasets[i] = {
        backgroundColor: trans(colors[i % colors.length]),
        borderColor: colors[i % colors.length],
        data: val,
        label: Object.keys(y[i])[0],
        fill : fill
        }
    }
    var options = {
        elements: {
        line: {
            tension: 0.1
        }
        },
        scales: {
        yAxes: [{
            stacked: true,
            ticks: {
            beginAtZero: false
            }
        }]
        },
        legend: {
        display: true,
        }
    }
    var ret = {
        type: 'line',
        data: data,
        options: options
    }
    return ret
    }
    sampleData = {"x": ["200104", "200105", "200106", "200107", "200108", "200109", "200110", "200111", "200112", "200201", "200202", "200203", "200204", "200205", "200206", "200207", "200208", "200209", "200210", "200211", "200212", "200301", "200302", "200303", "200304", "200305", "200306", "200307", "200308", "200309", "200310", "200311", "200312", "200401", "200402", "200403", "200404", "200405", "200406", "200407", "200408", "200409", "200410", "200411", "200412", "200501", "200502", "200503", "200504", "200505", "200506", "200507", "200508", "200509", "200510", "200511", "200512", "200601", "200602", "200603", "200604", "200605", "200606", "200607", "200608", "200609", "200610", "200611", "200612", "200701", "200702", "200703", "200704", "200705", "200706", "200707", "200708", "200709", "200710", "200711", "200712", "200801", "200802", "200803", "200804", "200805", "200806", "200807", "200808", "200809", "200810", "200811", "200812", "200901", "200902", "200903"], "y": {"予測": [{"実績": [11378293, 11776555, 12182914, 12544696, 12977266, 13284191, 13601456, 13957721, 14397219, 14814617, 15198001, 15534922, 15933465, 16238135, 16710629, 17148722, 17517559, 17958811, 18285402, 18636604, 19023263, 19363444, 19667742, 20054598, 20381295, 20722425, 20994912, 21352278, 21680042, 22068403, 22442684, 22839824, 23162889, 23579669, 23976123, 24320362, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]}, {"予測": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 24647059, 24988189, 25260676, 25618042, 25945806, 26334167, 26708448, 27105588, 27428653, 27845433, 28241887, 28586126, 28912823, 29253953, 29526440, 29883806, 30211570, 30599931, 30974212, 31371352, 31694417, 32111197, 32507651, 32851890, 33178587, 33519717, 33792204, 34149570, 34477334, 34865695, 35239976, 35637116, 35960181, 36376961, 36773415, 37117654, 37444351, 37785481, 38057968, 38415334, 38743098, 39131459, 39505740, 39902880, 40225945, 40642725, 41039179, 41383418, 41710115, 42051245, 42323732, 42681098, 43008862, 43397223, 43771504, 44168644, 44491709, 44908489, 45304943, 45649182]}]}}
    fetch('/get_dataFuture').then(function(response) {
        if (url.indexOf('github') >= 0){
            return sampleData
        } else {
            return response.json();
        }
    })
    .then(function(dataFuture) {
        chart = new Chart('future', areaConfig(dataFuture["x"], dataFuture["y"]["予測"]))
        var txt = '<table class="table table-striped table-sm table-hover">'
        item = "予測"
        txt += '<thead><tr align="right">'
        txt += '<th>月</th>'
        for (var i = 0; i < dataFuture["y"][item].length; i++){
        txt += '<th>'+ Object.keys(dataFuture["y"][item][i])[0] + '</th>'
        }            
        txt += '</tr></thead>'
        txt += '<tbody>'
        for (var r = 0; r < dataFuture["x"].length; r++) {
        txt += '<tr align="right">'
        txt += '<td>' + dataFuture["x"][r] + '</td>'
        for (var c = 0; c < dataFuture["y"][item].length; c++){
            x = Object.values(dataFuture["y"][item][c])[0][r]
            txt += '<td>' +  String(x).replace( /(\d)(?=(\d\d\d)+(?!\d))/g, '$1,') + '</td>'
        };
        txt += '</tr>'
        }
        txt += '</tbody>'
        txt += '</table>'
        $('#tbl').append(txt)
    })
  </script>
</body>
</html>
