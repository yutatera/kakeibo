<!doctype html>
<html>

<head>
  <meta charset="UTF-8">
  <title>家計簿</title>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="/static/style.css">
</head>

<body>
  <!--ナビゲーションウィンドウ-->
  <nav class="navbar navbar-expand navbar-dark bg-dark fixed-top">
    <div class="navbar-brand">家計簿</div>
    <div class="navbar-nav">
      <a class="nav-item nav-link" href="/">推移</a>
      <a class="nav-item nav-link" href="/future">予測</a>
      <a class="nav-item nav-link active" href="/month">月毎・年毎</a>
    </div>
  </nav>

  <div class="container-fluid">
  <div class="row">
    <!--サイドバー-->
    <div class="col-2">
    <div class="sidebar">
    <ul class="nav flex-column">
      <li class="nav-item">
        <span data-feather="settings"></span>
        <span class="navbar-text">設定</span>
      </li>
      <li><input type="radio" name="radio" id="年" value="年">年</li>
      <ul class="list-unstyled ml-2">
        <li><select name="year" id="year"></select></li>
      </ul>
      <li><input type="radio" name="radio" id="月" value="月"  checked="checked">月</li>
      <ul class="list-unstyled ml-2">
        <li><select name="month" id="month"></select></li>
      </ul>
    </ul>
    </div>
    </div>


    <!--メイン-->
    <main role="main" class="col-md-7">
      <h1>概要</h1>
      <div id="tbl_summary"></div>

      <h1>収入</h1>
      <canvas id="shunyu" height="30%" width="100%"></canvas>
      <div id="tbl_shunyu"></div>

      <h1>支出</h1>
      <canvas id="sishutu" height="30%" width="100%"></canvas>
      <div id="tbl_sishutu"></div>
    </main>
  </div>

  <!-- ----------------- -->
  <!-- ここからjavascript -->
  <!-- ----------------- -->
  <script>
    function makeTableMonth(id, month, items){
        fetch('/get_dataMonth_ave')
        .then(function(response) {
          return response.json();
        })
        .then(function(dataMonth_ave) {
       $(id).empty()
       dataMonth = dataMonth_ave[0]
       dataMonthAverage = dataMonth_ave[1]
      var txt = '<table class="table table-striped table-sm table-hover">'
      txt += '<thead><tr align="right">'
      txt += '<th>' + '項目' + '</th>'
      txt += '<th>' + '金額' + '</th>'
      if (items[0] == "支出小項目"){
        txt += '<th>' + '平均' + '</th>'
        txt += '<th>' + '差額' + '</th>'
      }
      txt += '</tr></thead>'
      txt += '<tbody>'
      for (item of items){
        for (var i = 0; i < Object.keys(dataMonth[month][item]).length; i++){
          txt += '<tr align="right">'
          txt += '<td>' + Object.keys(dataMonth[month][item])[i] + '</td>'
          x = Object.values(dataMonth[month][item])[i]
          txt += '<td>' +  String(x).replace( /(\d)(?=(\d\d\d)+(?!\d))/g, '$1,') + '</td>'
          if (items[0] == "支出小項目"){
            x2 = dataMonthAverage[i][1]
            txt += '<td>' +  String(x2).replace( /(\d)(?=(\d\d\d)+(?!\d))/g, '$1,') + '</td>'
            x3 = x - x2
            if (x3 > 0){
                txt += '<td><font color = "red">+' + String(x3).replace( /(\d)(?=(\d\d\d)+(?!\d))/g, '$1,') + '</font></td>'
            } else {
                txt += '<td><font color = "blue">' + String(x3).replace( /(\d)(?=(\d\d\d)+(?!\d))/g, '$1,') + '</font></td>'
            }
          }
          txt += '</tr>'
        }
      }
      txt += '</tbody>'
      txt += '</table>'
      $(id).append(txt)
        })
    }

    function makeTableYear(id, month, items){
        fetch('/get_dataYear')
        .then(function(response) {
          return response.json();
        })
        .then(function(dataYear) {
        $(id).empty()
        var txt = '<table class="table table-striped table-sm table-hover">'
        txt += '<thead><tr align="right">'
        txt += '<th>' + '項目' + '</th>'
        txt += '<th>' + '金額' + '</th>'
        txt += '</tr></thead>'
        txt += '<tbody>'
        for (item of items){
            for (var i = 0; i < Object.keys(dataYear[month][item]).length; i++){
            txt += '<tr align="right">'
            txt += '<td>' + Object.keys(dataYear[month][item])[i] + '</td>'
            x = Object.values(dataYear[month][item])[i]
            txt += '<td>' +  String(x).replace( /(\d)(?=(\d\d\d)+(?!\d))/g, '$1,') + '</td>'
            txt += '</tr>'
            }
        }
        txt += '</tbody>'
        txt += '</table>'
        $(id).append(txt)})
    }

    function outConfig(x , y){
      var colors = [
        'rgb(  0,   0, 255)',
        'rgb(  0, 203, 255)',
        'rgb(255, 255,   0)',
        'rgb(216, 255, 204)',
        'rgb(  0, 255,   0)',
        'rgb(  0, 101,   0)',
        'rgb(255, 63,    0)',
        'rgb( 203,  0, 203)',
        'rgb(  0,   0,  50)'
      ]
      col = []
      for (i = 0; i< y.length; i++){
        col[i] = colors[i % colors.length]
      }
      var config = {
        type: 'pie',
        data: {
          datasets: [{
            data: y,
            backgroundColor: colors,
            label: 'Dataset 1'
          }],
          labels: x
        },
        options: {
          responsive: true
        }
      };
      return config
    }

    function update(initFlag){

      slct = $('input[name=radio]:checked').val()

      if(initFlag == false){
        window.myPie1.destroy()
        window.myPie2.destroy()
      }

      // 収入
      if(slct == "月"){
        fetch('/get_dataMonth')
        .then(function(response) {
          return response.json();
        })
        .then(function(dataMonth) {
        month = $("#month option:selected").val();
        var x = Object.keys(dataMonth[month]["収入項目"])
        var y = Object.values(dataMonth[month]["収入項目"])
        config = outConfig(x, y)
        var ctx = document.getElementById('shunyu').getContext('2d');
        window.myPie1 = new Chart(ctx, config);

        // 支出
        var x = Object.keys(dataMonth[month]["支出大項目"])
        var y = Object.values(dataMonth[month]["支出大項目"])
        config = outConfig(x, y)
        var ctx = document.getElementById('sishutu').getContext('2d');
        window.myPie2 = new Chart(ctx, config);

        makeTableMonth('#tbl_summary', month, ["収入", "支出", "収支"])
        makeTableMonth('#tbl_shunyu', month, ["収入項目"])
        makeTableMonth('#tbl_sishutu', month, ["支出小項目"])})
      } else if(slct == "年"){
        fetch('/get_dataYear')
        .then(function(response) {
          return response.json();
        })
        .then(function(dataYear) {
          
        year = $("#year option:selected").val();
        var x = Object.keys(dataYear[year]["収入項目"])
        var y = Object.values(dataYear[year]["収入項目"])
        config = outConfig(x, y)
        var ctx = document.getElementById('shunyu').getContext('2d');
        window.myPie1 = new Chart(ctx, config);

        // 支出
        var x = Object.keys(dataYear[year]["支出大項目"])
        var y = Object.values(dataYear[year]["支出大項目"])
        config = outConfig(x, y)
        var ctx = document.getElementById('sishutu').getContext('2d');
        window.myPie2 = new Chart(ctx, config);

        makeTableYear('#tbl_summary', year, ["収入", "支出", "収支"])
        makeTableYear('#tbl_shunyu', year, ["収入項目"])
        makeTableYear('#tbl_sishutu', year, ["支出小項目"])})
      }
    }

    // アイコンの表示
    feather.replace()

    // selectBox(期間)のリスト設定
    fetch('/get_month')
      .then(function(response) {
        return response.json();
      })
      .then(function(month) {
        var arr = month
        for(var j = arr.length - 1; j >= 0; j--){
            let op = document.createElement("option");
            op.value = arr[j];
            op.text = arr[j];
            document.getElementById("month").appendChild(op);
        }
      });
    // selectBox(期間)のリスト設定
    fetch('/get_year').then(function(response) {
      return response.json();
    }).then(function(year) {
        var arr = year
        for(var j = arr.length - 1; j >= 0; j--){
            let op = document.createElement("option");
            op.value = arr[j];
            op.text = arr[j];
            document.getElementById("year").appendChild(op);
        }
    })

    $("#month").change(function(){
      var element = document.getElementById("月");
      element.checked = true ;
      update(false)
    })
    $("#year").change(function(){
      var element = document.getElementById("年");
      element.checked = true ;
      update(false)
    })
    $('input[name="radio"]:radio').change(function(){
      update(false)
    });

    update(true)


  </script>
</body>
</html>
